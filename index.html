<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Smarter Investment - Control inteligente de gastos, ingresos y presupuestos con IA">
    <meta name="theme-color" content="#05BFDB">
    
    <!-- PWA Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Smarter">
    
    <!-- Favicon -->
    <link rel="icon" type="image/jpeg" href="logo-smarter.jpg">
    
    <!-- Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <title>Smarter Investment - Tu Gestor Financiero Personal</title>
    
    <!-- Preconnect a dominios críticos -->
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="dns-prefetch" href="https://firestore.googleapis.com">
    
    <!-- CSS Principal -->
    <link rel="stylesheet" href="styles.css">
    
    <!-- Toastify -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    
    <!-- Firebase SDK COMPAT (Compatible con tu código) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- Chart.js (solo cargar cuando se necesite) -->
    <script>
        // Función para cargar Chart.js bajo demanda
        window.loadChartJS = function() {
            return new Promise((resolve, reject) => {
                if (window.Chart) {
                    resolve();
                    return;
                }
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js';
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        };
    </script>
    
    <!-- Toastify JS -->
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    
    <style>
        input[type="number"],
        input[type="text"],
        input[type="email"],
        input[type="password"],
        select {
            font-size: 16px !important;
        }
        
        body {
            overscroll-behavior-y: contain;
            overscroll-behavior: contain;
        }
        
        /* Splash screen */
        #splash-screen {
            position: fixed;
            inset: 0;
            background: #000B2E;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s;
        }
        
        #splash-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(5, 191, 219, 0.3);
            border-top-color: #05BFDB;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Splash screen -->
    <div id="splash-screen">
        <div style="text-align: center;">
            <img src="logo-smarter.jpg" alt="Smarter Investment" 
                 style="width: 150px; height: 150px; border-radius: 30px; margin-bottom: 20px;"
                 onerror="this.style.display='none'">
            <div class="spinner"></div>
            <p style="color: white; margin-top: 20px;">Cargando...</p>
        </div>
    </div>
    
    <div id="app"></div>
    
    <!-- Loader Global -->
    <div id="global-loader" style="display: none;">
        <div class="loader-backdrop"></div>
        <div class="loader-spinner">
            <div class="spinner"></div>
            <p id="loader-text">Cargando...</p>
        </div>
    </div>
    
    <!-- Inicializar Firebase -->
    <script>
        // ✅ Configuración Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyC_qB7H-bj_fS3DPn7Rne6Aqr3FDkJPkEY",  // REEMPLAZA con tu API key real
            authDomain: "tu-proyecto.firebaseapp.com",
            projectId: "tu-proyecto-id",
            storageBucket: "tu-proyecto.appspot.com",
            messagingSenderId: "123456789",
            appId: "tu-app-id"
        };
        
        // Inicializar Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            console.log('✅ Firebase inicializado correctamente');
            
            // Hacer disponible globalmente
            window.firebaseApp = firebase.app();
            window.firebaseAuth = firebase.auth();
            window.firebaseDb = firebase.firestore();
            
            // Ocultar splash screen después de inicializar
            setTimeout(() => {
                const splash = document.getElementById('splash-screen');
                if (splash) {
                    splash.classList.add('hidden');
                    setTimeout(() => splash.remove(), 500);
                }
            }, 1000);
            
        } catch (error) {
            console.error('❌ Error inicializando Firebase:', error);
            alert('Error al inicializar la aplicación. Por favor, recarga la página.');
        }
    </script>
    
    <!-- Sistema de carga dinámica de módulos -->
    <script>
        const ModuleLoader = {
            loaded: new Set(),
            loading: new Map(),
            
            async load(moduleName) {
                if (this.loaded.has(moduleName)) {
                    return Promise.resolve();
                }
                
                if (this.loading.has(moduleName)) {
                    return this.loading.get(moduleName);
                }
                
                const loadPromise = new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = `${moduleName}-module.js`;
                    script.async = true;
                    script.onload = () => {
                        this.loaded.add(moduleName);
                        this.loading.delete(moduleName);
                        console.log(`✅ Módulo ${moduleName} cargado`);
                        resolve();
                    };
                    script.onerror = () => {
                        this.loading.delete(moduleName);
                        console.error(`❌ Error cargando módulo ${moduleName}`);
                        reject(new Error(`Failed to load ${moduleName}`));
                    };
                    document.body.appendChild(script);
                });
                
                this.loading.set(moduleName, loadPromise);
                return loadPromise;
            }
        };
        
        window.ModuleLoader = ModuleLoader;
    </script>
    
    <!-- Módulos CORE (cargar siempre) -->
    <script src="state-manager.js"></script>
    <script src="form-validator.js"></script>
    <script src="error-handler.js"></script>
    <script src="analytics.js"></script>
    
    <!-- Notificaciones (cargar siempre) -->
    <script src="notifications-module.js"></script>
    
    <!-- Módulos de funcionalidad (cargar bajo demanda) -->
    <!-- Estos se cargarán dinámicamente cuando se necesiten -->
    
    <!-- Script principal -->
    <script src="app.js"></script>
    
    <!-- Service Worker -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('./service-worker.js');
                    console.log('✅ Service Worker registrado:', registration.scope);
                    
                    // Detectar actualizaciones
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                if (confirm('¡Nueva versión disponible! ¿Actualizar ahora?')) {
                                    newWorker.postMessage({ type: 'SKIP_WAITING' });
                                    window.location.reload();
                                }
                            }
                        });
                    });
                    
                } catch (error) {
                    console.log('⚠️ Error al registrar Service Worker:', error);
                }
            });
            
            // Recargar cuando el SW se actualiza
            let refreshing = false;
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                if (!refreshing) {
                    refreshing = true;
                    window.location.reload();
                }
            });
        }
    </script>
</body>
</html>
